{% extends "auctions/base.html" %}
{% block title %}{{ item.title }}{% endblock %}
{% block subtitle %}{{ item.category.name }}{% endblock %}
{% block content %}
  <article>
    <h2>{{ item.title }}</h2>
    <p>{{ item.description|linebreaks }}</p>
    {% if item.restrictions %}
      <p><strong>Restrictions:</strong> {{ item.restrictions|linebreaks }}</p>
    {% endif %}
    {% if messages %}
      <ul class="messages" style="padding: .5rem 1rem; margin:.5rem 0; border:1px solid #ddd; border-radius:6px; list-style: none;">
        {% for message in messages %}
          <li class="{{ message.tags }}" style="margin:.25rem 0;">
            {{ message }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    <ul>
      {% if item.opening_min_bid %}<li><strong>Opening bid:</strong> ${{ item.opening_min_bid }}</li>{% endif %}
      {% if item.bid_increment %}<li><strong>Increment:</strong> ${{ item.bid_increment }}</li>{% endif %}
      {% if item.buy_now_price %}<li><strong>Buy Now:</strong> ${{ item.buy_now_price }}</li>{% endif %}
      <li><strong>Type:</strong> {{ item.get_type_display }}</li>
      <li><strong>Status:</strong> {{ item.get_status_display }}</li>
    </ul>

    {% if manager_can_publish %}
      <form method="post" action="{% url 'auctions:manager_publish_item' slug=item.slug %}">
        {% csrf_token %}
        <button type="submit">Publish Item (Manager)</button>
      </form>
    {% endif %}

    {% if can_bid %}
      <section>
        <h3>Bidding</h3>
        {% if bid_seats_total %}
          <p>
            <strong>Seats:</strong>
            {{ bid_seats_total }} total
            Â· {{ bid_seats_available }} available without a bid yet
          </p>
        {% endif %}
        {% if top_bid %}
          <p><strong>Current top bid:</strong> ${{ top_bid.amount }}</p>
        {% else %}
          <p>No bids yet.</p>
        {% endif %}
        {% if request.user.is_authenticated %}
          <form method="post" action="{% url 'auctions:place_bid' slug=item.slug %}">
            {% csrf_token %}
            <label>Maximum bid (proxy): <input type="number" step="0.01" name="amount" required></label>
            <label style="margin-left:1rem;">Quantity: <input type="number" name="quantity" min="1" {% if bid_seats_total %}max="{{ bid_seats_total }}"{% endif %} value="1"></label>
            <input type="hidden" name="idempotency_key" value="{{ request.session.session_key }}-{{ item.slug }}-bid">
            <button type="submit">Place Bid</button>
          </form>
        {% else %}
          <p><a href="{% url 'auctions:login' %}">Log in</a> to place a bid.</p>
        {% endif %}
      </section>
    {% endif %}

    {% include 'auctions/partials/signup_section.html' %}
    <p><a href="/">Back to catalog</a></p>
  </article>
{% endblock %}
