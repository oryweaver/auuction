{% extends "auctions/base.html" %}

{% block title %}{% if mode == 'edit' %}Edit Draft Item{% else %}Propose New Item{% endif %} Â· TVUUC Auction{% endblock %}
{% block subtitle %}{% if mode == 'edit' %}Update your draft donation{% else %}Tell us about your donation{% endif %}{% endblock %}

{% block content %}
<article>
  <h2>{% if mode == 'edit' %}Edit Draft Item{% else %}Propose New Item{% endif %}</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="grid">
      <div>
        <label for="id_title">Title</label>
        {{ form.title }}
        {% if form.title.errors %}<small class="msg-error">{{ form.title.errors|striptags }}</small>{% endif %}
      </div>
      <div>
        <label for="id_type">Type</label>
        {{ form.type }}
        <small id="type-help" class="msg-info">Select the bidding item type. Fixed-price signups are created later by managers.</small>
        {% if form.type.errors %}<small class="msg-error">{{ form.type.errors|striptags }}</small>{% endif %}
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="id_category">Category</label>
        {{ form.category }}
        {% if form.category.errors %}<small class="msg-error">{{ form.category.errors|striptags }}</small>{% endif %}
      </div>
    </div>

    <label for="id_description">Description</label>
    {{ form.description }}
    {% if form.description.errors %}<small class="msg-error">{{ form.description.errors|striptags }}</small>{% endif %}

    <label for="id_restrictions">Restrictions</label>
    {{ form.restrictions }}
    {% if form.restrictions.errors %}<small class="msg-error">{{ form.restrictions.errors|striptags }}</small>{% endif %}

    <div class="grid">
      <div>
        <label for="id_image">Image</label>
        {{ form.image }}
        {% if form.image.errors %}<small class="msg-error">{{ form.image.errors|striptags }}</small>{% endif %}
        {% if mode == 'edit' and item and item.image %}
          <div style="margin-top:.5rem;">
            <small class="msg-info">Current image preview:</small><br>
            <img src="{{ item.image.url }}" alt="{{ item.title }}" style="max-width:200px; height:auto; border:1px solid #ddd;">
          </div>
        {% endif %}
      </div>
    </div>

    <div class="grid" id="bidding-fields">
      <div>
        <label for="id_opening_min_bid">Opening minimum bid</label>
        {{ form.opening_min_bid }}
        {% if form.opening_min_bid.errors %}<small class="msg-error">{{ form.opening_min_bid.errors|striptags }}</small>{% endif %}
        <small class="msg-info">Bid increments are calculated automatically.</small>
      </div>
      <div id="buy-now-fields" style="display:flex; flex-direction:column; gap:.25rem;">
        <div style="display:flex; align-items:end; gap:.5rem; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column;">
            <label for="id_buy_now_price">Buy-It-Now price</label>
            {{ form.buy_now_price }}
          </div>
        </div>
        {% if form.buy_now_price.errors %}<small class="msg-error">{{ form.buy_now_price.errors|striptags }}</small>{% endif %}
        <small class="msg-info">Defaults to the opening minimum bid if left blank.</small>
        <label style="margin-top:.25rem;">
          {{ form.enable_buy_now }} Offer Buy-It-Now option (if not sold durring bidding period)
        </label>
      </div>
    </div>

    <fieldset id="event-location" style="margin-top: .5rem;">
      <legend>Event Details</legend>
      <div class="grid">
        <div>
          <label for="id_event_starts_at">Event start</label>
          {{ form.event_starts_at }}
          {% if form.event_starts_at.errors %}<small class="msg-error">{{ form.event_starts_at.errors|striptags }}</small>{% endif %}
        </div>
        <div>
          <label for="id_event_ends_at">Event end</label>
          {{ form.event_ends_at }}
          {% if form.event_ends_at.errors %}<small class="msg-error">{{ form.event_ends_at.errors|striptags }}</small>{% endif %}
        </div>
      </div>
      <small class="msg-info">Start and end are optional for donors; managers can finalize later.</small>
      <legend style="margin-top:.5rem;">Event Location</legend>
      <label>
        {{ form.at_church }} Held at the church
      </label>
      <div id="custom-location">
        <label for="id_location_name">Location name</label>
        {{ form.location_name }}
        {% if form.location_name.errors %}<small class="msg-error">{{ form.location_name.errors|striptags }}</small>{% endif %}
        <label for="id_location_address">Address / details</label>
        {{ form.location_address }}
        {% if form.location_address.errors %}<small class="msg-error">{{ form.location_address.errors|striptags }}</small>{% endif %}
      </div>
    </fieldset>

    <div class="grid">
      <div>
        <label for="id_quantity_total">Total seats/quantity (for events)</label>
        {{ form.quantity_total }}
        {% if form.quantity_total.errors %}<small class="msg-error">{{ form.quantity_total.errors|striptags }}</small>{% endif %}
      </div>
    </div>

    <footer style="margin-top:1rem; display:flex; gap:.5rem;">
      <button type="submit">Save</button>
      <a role="button" class="secondary" href="{% if mode == 'edit' and item %}{% url 'auctions:donor_item_edit' slug=item.slug %}{% else %}{% url 'auctions:account_home' %}{% endif %}">Cancel</a>
    </footer>
  </form>

  <small class="msg-info" id="requirements-note">All donor-submitted items are bid during phase 1. Provide an opening minimum; increments are automatic. For events, provide a location and capacity.</small>
</article>

<script>
  (function(){
    function byId(id){ return document.getElementById(id); }
    function updateVisibility(){
      var sel = document.getElementById('id_type');
      if(!sel) return;
      var t = sel.value;
      var bidding = (t === 'good' || t === 'service' || t === 'event');
      var bf = byId('bidding-fields');
      var eventLoc = byId('event-location');
      if (bf) bf.style.display = bidding ? '' : 'none';
      if (eventLoc) eventLoc.style.display = (t === 'event') ? '' : 'none';

      // Toggle custom location sub-fields when at_church is checked
      var atChurch = document.getElementById('id_at_church');
      var customLoc = byId('custom-location');
      if (customLoc) customLoc.style.display = (t === 'event' && atChurch && !atChurch.checked) ? '' : 'none';
    }
    function updateBuyNowState(){
      var typeSel = document.getElementById('id_type');
      var bidding = typeSel && (typeSel.value === 'good' || typeSel.value === 'service' || typeSel.value === 'event');
      var cb = document.getElementById('id_enable_buy_now');
      var price = document.getElementById('id_buy_now_price');
      var bnWrap = byId('buy-now-fields');
      if (bnWrap) bnWrap.style.display = bidding ? '' : 'none';
      if (price) price.disabled = !(cb && cb.checked && bidding);
    }
    document.addEventListener('change', function(e){
      if(!e.target) return;
      if(e.target.id === 'id_type' || e.target.id === 'id_at_church' || e.target.id === 'id_enable_buy_now'){
        updateVisibility();
        updateBuyNowState();
      }
    });
    document.addEventListener('DOMContentLoaded', function(){ updateVisibility(); updateBuyNowState(); });
  })();
  </script>
{% endblock %}
